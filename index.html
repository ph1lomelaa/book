<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hickmet Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –±–µ–∂–µ–≤–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --bg-primary: #FAF8F5;
            --bg-secondary: #F5F1EB;
            --bg-card: #FFFFFF;
            --accent-brown: #9B8474;
            --accent-dark: #6B5D52;
            --accent-light: #C4B5A7;
            --text-primary: #3D3935;
            --text-secondary: #8A827C;
            --border-color: #E8E3DC;
            --shadow-soft: 0 4px 12px rgba(107, 93, 82, 0.08);
            --shadow-medium: 0 8px 24px rgba(107, 93, 82, 0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-bottom: 60px;
            min-height: 100vh;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-dark);
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .app-header p {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .step.active {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-color: var(--accent-dark);
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.3);
        }

        .step.completed {
            background: #E8F5E9;
            border-color: #2E7D32;
            color: #2E7D32;
        }
        
        label {
            display: block;
            margin-top: 18px;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            background-color: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(107, 93, 82, 0.04);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-brown);
            background-color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(155, 132, 116, 0.15);
            transform: translateY(-1px);
        }
        
        .row {
            display: flex;
            gap: 12px;
        }
        
        .col {
            flex: 1;
        }
        
        .manager-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .manager-control select,
        .manager-control input {
            flex: 1;
        }
        
        .name-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .name-row .name-input {
            flex: 1;
            font-size: 14px;
        }

        .name-hint {
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .gender-select {
            margin-top: 10px;
            font-size: 14px;
        }

        /* –ß–µ–∫–±–æ–∫—Å—ã INF/CHD */
        .passenger-type-checkboxes {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        .passenger-type-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: none;
            letter-spacing: 0;
            margin: 0;
            padding: 0;
        }

        .passenger-type-checkboxes input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-brown);
        }

        .passenger-type-checkboxes label:hover {
            color: var(--accent-dark);
        }
        
        /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ */
        .city-buttons, .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .city-buttons input, .radio-group input {
            display: none;
        }
        
        .city-buttons label, .radio-group label {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
            box-shadow: var(--shadow-soft);
        }
        
        .city-buttons label:hover, .radio-group label:hover {
            border-color: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .city-buttons input:checked + label, .radio-group input:checked + label {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-color: var(--accent-dark);
            box-shadow: 0 6px 16px rgba(107, 93, 82, 0.25);
        }
        .edit-notice {
            display: none;
            margin: 12px 0;
            padding: 12px 14px;
            border-radius: 10px;
            background: #FFF5E0;
            color: #8A5B00;
            border: 1px solid #FFD18C;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ */
        .tourist-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }
        
        .tourist-card:hover {
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-light);
        }
        
        .tourist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .tourist-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-dark);
        }
        
        .passport-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(107, 93, 82, 0.2);
        }
        
        .passport-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.3);
        }
        
        .passport-btn:active {
            transform: translateY(0);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .submit-btn {
            width: 100%;
            padding: 18px;
            margin-top: 24px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(107, 93, 82, 0.25);
            letter-spacing: 0.5px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 28px rgba(107, 93, 82, 0.35);
        }
        
        .submit-btn:active {
            transform: translateY(-1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Smart box */
        .smart-box {
            background: linear-gradient(135deg, #FFFFFF 0%, var(--bg-secondary) 100%);
            padding: 20px;
            border-radius: 18px;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
        }
        
        .smart-box h3 {
            color: var(--accent-dark);
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 700;
        }
        
        /* –î–∞–Ω–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ */
        .passport-data {
            background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
            padding: 14px;
            border-radius: 12px;
            margin-top: 12px;
            border: 2px solid #C8E6C9;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .phone-input {
            margin-top: 8px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .passport-data.visible {
            display: block;
        }
        
        .passport-field {
            font-size: 14px;
            margin: 6px 0;
            color: var(--text-primary);
            display: flex;
            padding: 6px 0;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .passport-field:last-child {
            border-bottom: none;
        }
        
        .passport-field strong {
            color: #2E7D32;
            min-width: 150px;
            font-weight: 600;
        }
        
        /* Details/Summary */
        details {
            margin-top: 20px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 14px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-soft);
        }
        
        summary {
            font-weight: 700;
            padding: 14px;
            cursor: pointer;
            color: var(--accent-dark);
            font-size: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            list-style: none;
        }
        
        summary:hover {
            background: var(--bg-secondary);
        }
        
        summary::-webkit-details-marker {
            display: none;
        }
        
        summary::before {
            content: "üìÇ ";
            margin-right: 8px;
        }
        
        details[open] summary::before {
            content: "üìÇ ";
        }
        
        details > div {
            padding: 14px;
        }
        
        /* –ü–æ–∏—Å–∫ –¥–∞—Ç—ã */
        .date-search {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .date-search input {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        .search-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-radius: 12px;
            padding: 0 24px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.2);
            white-space: nowrap;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 93, 82, 0.3);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */
        .back-btn {
            width: 100%;
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            margin-top: 12px;
            padding: 14px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            border-color: var(--accent-light);
            color: var(--accent-brown);
            background: var(--bg-secondary);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* –ò–∫–æ–Ω–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ */
        .icon {
            display: inline-block;
            margin-right: 6px;
        }

        .start-box {
            margin-top: 16px;
        }

        .choice-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .choice-row button {
            flex: 1;
        }

        .sub-btn {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            background: var(--bg-card);
            cursor: pointer;
            font-weight: 700;
            color: var(--accent-dark);
            transition: all 0.2s ease;
        }

        .sub-btn:hover {
            border-color: var(--accent-light);
            transform: translateY(-1px);
        }

        .dropzone {
            margin-top: 12px;
            padding: 16px;
            border: 2px dashed var(--border-color);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.6);
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .dropzone.dragover {
            border-color: var(--accent-brown);
            background: rgba(155, 132, 116, 0.08);
            color: var(--accent-dark);
        }

        .file-list {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            margin-top: 6px;
        }

	        .file-status {
	            font-weight: 700;
	            color: var(--accent-dark);
	            white-space: nowrap;
	        }

	        .file-actions {
	            display: flex;
	            align-items: center;
	            gap: 12px;
	        }

	        .file-remove {
	            border: none;
	            background: none;
	            padding: 0;
	            cursor: pointer;
	            font-weight: 700;
	            font-size: 13px;
	            color: #B42318;
	            text-decoration: underline;
	        }

	        .file-remove:disabled {
	            opacity: 0.5;
	            cursor: not-allowed;
	            text-decoration: none;
	        }

	        .help-text {
	            margin-top: 10px;
	            font-size: 13px;
	            color: var(--text-secondary);
	            line-height: 1.35;
        }
    </style>
</head>
<body>

<div class="app-header">
    <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –£–º—Ä—ã</h1>
</div>
<div id="edit_notice" class="edit-notice">
    ‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –ø–∞–∫–µ—Ç –∏ –¥–∞—Ç–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã, –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞.
</div>

<div id="step_0" style="display: none;">
    <div class="smart-box start-box">
        <h3>–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å</h3>
        <button class="submit-btn" id="create_booking_btn" type="button">–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å</button>

        <div id="create_flow" style="display: none; margin-top: 14px;">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤:</label>
            <input type="number" id="pilgrims_count_input" min="1" max="30" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5">

            <div class="choice-row">
                <button class="sub-btn" id="fill_tg_btn" type="button">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤ Telegram</button>
                <button class="sub-btn" id="fill_form_btn" type="button">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤ —Ñ–æ—Ä–º–µ</button>
            </div>

            <div id="form_passport_block" style="display:none; margin-top: 14px;">
                <label>–ü–∞—Å–ø–æ—Ä—Ç–∞:</label>
                <div class="choice-row">
                    <button class="sub-btn" id="passports_all_btn" type="button">–í—Å–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ –µ—Å—Ç—å</button>
                    <button class="sub-btn" id="passports_partial_btn" type="button">–ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞</button>
                </div>

                <div class="dropzone" id="passport_dropzone">
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ —Å—é–¥–∞ (jpg/png/pdf) –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã¬ª
                    <div style="margin-top:10px;">
                        <button class="sub-btn" id="choose_files_btn" type="button">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                        <input type="file" id="passports_files_input" accept=".jpg,.jpeg,.png,.pdf" multiple style="display:none;">
                    </div>
                </div>

                <div class="file-list" id="files_list"></div>

                <button class="submit-btn" id="start_processing_btn" type="button" style="margin-top: 14px;" disabled>
                    –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
                </button>
                <div class="help-text">
                    –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É¬ª. –ï—Å–ª–∏ —É —á–∞—Å—Ç–∏ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ –Ω–µ—Ç –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ ‚Äî –∏—Ö –∏–º—è/—Ñ–∞–º–∏–ª–∏—é –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–µ –≤—Ä—É—á–Ω—É—é (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ).
                </div>
            </div>
        </div>
    </div>
</div>

<div id="step_1">
    <div class="step-indicator">
        <div class="step active">1</div>
        <div class="step">2</div>
    </div>

    <div class="smart-box">
        <label><span class="icon"></span>1. –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</label>
        <div class="date-search">
            <input type="text" id="date_input" placeholder="13.12">
            <button type="button" onclick="handleSearch()" class="search-btn">–ù–∞–π—Ç–∏</button>
        </div>

        <label style="margin-top: 16px;"><span class="icon"></span>2. –ü–∞–∫–µ—Ç:</label>
        <select id="pkg_name" disabled>
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É</option>
        </select>
    </div>

    <input type="hidden" id="sheet_name_hidden">
    <input type="hidden" id="table_id_hidden">

    <label><span class="icon">üõ´</span>–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞:</label>
    <div class="city-buttons">
        <input type="radio" name="departure_city" id="c_ala" value="Almaty" checked>
        <label for="c_ala">Almaty</label>
        <input type="radio" name="departure_city" id="c_ast" value="Astana">
        <label for="c_ast">Astana</label>
    </div>

    <label><span class="icon"></span>–ü–∞–ª–æ–º–Ω–∏–∫–∏:</label>
    <div id="pilgrims-container"></div>

    <div class="row">
        <div class="col">
            <label>AVIA –∑–∞–ø—Ä–æ—Å:</label>
            <input type="text" id="avia" placeholder="">
        </div>
        <div class="col">
            <label>VISA –¥–µ–π—Å—Ç–≤—É—é—â–∞—è:</label>
            <select id="visa_status">
                <option value="-">NO VISA</option>
                <option value="TOUR VISA">TOUR VISA</option>
                <option value="UMRAH VISA">UMRAH VISA</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>–¢–∏–ø –Ω–æ–º–µ—Ä–∞:</label>
            <select id="room_type">
                <option value="Double">Double</option>
                <option value="Triple">Triple</option>
                <option value="Quad">Quad</option>
                <option value="Single">Single</option>
            </select>
        </div>
        <div class="col">
            <label>–ü–∏—Ç–∞–Ω–∏–µ:</label>
            <select id="meal_type">
                <option value="HB">HB</option>
                <option value="BB">BB</option>
                <option value="FB">FB</option>
                <option value="INF">INF</option>
                <option value="CHD">CHD</option>
                <option value="RO">RO</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>–°—É–º–º–∞ –ø–∞–∫–µ—Ç–∞ ($):</label>
            <input type="tel" id="price" placeholder="">
        </div>
        <div class="col">
            <label>–û–ø–ª–∞—á–µ–Ω–æ ($):</label>
            <input type="tel" id="amount_paid" value="">
        </div>
    </div>

    <details>
        <summary>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</summary>
        <div>
            <label>–†–µ–≥–∏–æ–Ω:</label>
            <select id="region">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                <option value="Almaty">–ê–ª–º–∞—Ç—ã</option>
                <option value="Astana">–ê—Å—Ç–∞–Ω–∞</option>
                <option value="Shymkent">–®—ã–º–∫–µ–Ω—Ç</option>
                <option value="Atyrau">–ê—Ç—ã—Ä–∞—É</option>
                <option value="Aktobe">–ê–∫—Ç–æ–±–µ</option>
                <option value="Karaganda">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option>
                <option value="Kostanay">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                <option value="Pavlodar">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                <option value="Turkistan">–¢—É—Ä–∫–µ—Å—Ç–∞–Ω</option>
                <option value="Mangystau">–ú–∞–Ω–≥–∏—Å—Ç–∞—É</option>
                <option value="EastKazakhstan">–í–ö–û</option>
                <option value="WestKazakhstan">–ó–ö–û</option>
                <option value="NorthKazakhstan">–°–ö–û</option>
                <option value="Kyzylorda">–ö—ã–∑—ã–ª–æ—Ä–¥–∞</option>
                <option value="Zhambyl">–ñ–∞–º–±—ã–ª</option>
                <option value="Abai">–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option value="Ulytau">–£–ª—ã—Ç–∞—É</option>
                <option value="Jetisu">–ñ–µ—Ç—ã—Å—É</option>
                <option value="Other">–î—Ä—É–≥–æ–π</option>
            </select>

            <label>–î–æ–≥–æ–≤–æ—Ä ‚Ññ:</label>
            <input type="text" id="contract_number" value="">

            <label>–ö—É—Ä—Å $:</label>
            <input type="tel" id="exchange_rate" placeholder="">

            <label>–°–∫–∏–¥–∫–∞:</label>
            <input type="text" id="discount" value="">

            <label>–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
            <input type="text" id="source" placeholder="">

            <label>–ü–æ–µ–∑–¥:</label>
            <select id="train">
                <option value="-">–ù–µ—Ç</option>
                <option value="YES">–î–∞</option>
            </select>
        </div>
    </details>

    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <div class="manager-control">
        <select id="manager_select"></select>
        <input type="text" id="manager_custom_input" placeholder="–ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, —É–∫–∞–∂–∏—Ç–µ –∏–º—è" style="display: none;">
    </div>
    <input type="hidden" id="manager_name_text">
    
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>

    <button class="submit-btn" onclick="goToStep2()">
        <span class="icon">‚û°Ô∏è</span> –î–ê–õ–ï–ï –ö –†–ê–ó–ú–ï–©–ï–ù–ò–Æ
    </button>
</div>

<div id="step_2" style="display: none;">
    <div class="step-indicator">
        <div class="step completed">‚úì</div>
        <div class="step active">2</div>
    </div>

    <div class="smart-box">
        <h3>–†–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>

        <div id="group_logic" style="display: none; margin-bottom: 20px;">
            <label>–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:</label>
            <div class="city-buttons">
                <input type="radio" name="placement_type" id="m_fam" value="family">
                <label for="m_fam">üë™ –°–µ–º—å—è (–≤–º–µ—Å—Ç–µ)</label>
                <input type="radio" name="placement_type" id="m_sep" value="separate" checked>
                <label for="m_sep">üöª –†–∞–∑–¥–µ–ª—å–Ω–æ (–ø–æ –ø–æ–ª—É)</label>
            </div>
        </div>

        <label>–ú–µ—Ç–æ–¥ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É:</label>
        <div class="radio-group" style="flex-direction: column;">
            <input type="radio" name="place_method" id="meth_auto" value="auto" checked onchange="updateUI()">
            <label for="meth_auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–≤–æ–±–æ–¥–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ)</label>

            <input type="radio" name="place_method" id="meth_pick" value="pick" onchange="updateUI()">
            <label for="meth_pick">–ü–æ–¥—Å–µ–ª–∏—Ç—å (–í—ã–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É)</label>

        </div>

        <div id="room_list_div" style="display: none; margin-top: 20px;">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ:</label>
            <select id="room_select"></select>
        </div>

        <div id="manual_div" style="display: none; margin-top: 20px;">
            <label>–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–ø—Ä. 145):</label>
            <input type="number" id="manual_row_input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏">
        </div>
    </div>

    <button class="submit-btn" id="finish_btn" onclick="finalSubmit()">
        <span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨
    </button>
    <button onclick="backToStep1()" class="back-btn">
        <span class="icon">‚¨ÖÔ∏è</span> –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º
    </button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const API_URL = window.BULL_API_URL;
    let pilgrimsData = [];
    let currentMode = 'create';
    let currentBookingId = null;

    // –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏ –≤–Ω—É—Ç—Ä–∏ WebApp (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞, —Å—Ç–∞—Ä–∞—è –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
    let creationMode = null; // 'tg' | 'form' | null
    let creationCount = 0;
    let passportsCompleteness = 'partial'; // 'all' | 'partial'
    let passportFiles = [];
    let processingInProgress = false;

    const MANAGER_NAMES = [
        'Ulzhan',
        'Bayan',
        'Perizat',
        'Zhanerke',
        'Nazerke',
        'Bektay',
        'Islam',
        'Nursultan',
        'Qymbat',
        'BAGDAT',
        'SHYNGYS',
        'SAGYNDYK',
        'ARSEN',
        'KULYAN',
        'MARZUHA',
        'AIYM',
        'AYAZHAN',
        'Omirkhan',
        'Olzhas',
        'Zarina',
        'Symbat',
        'Akzhol',
        'bekbergen',
        'AKTOLKYN',
        'Arsentai',
        'Madi Turkestan',
        'ADILET',
        'Zhandos',
        'Bakhyt',
        'Sardar',
        'Yerkezhan',
        'MURAT'
    ];

    const managerSelect = document.getElementById('manager_select');
    const managerCustomInput = document.getElementById('manager_custom_input');
    const managerHiddenInput = document.getElementById('manager_name_text');

    function renderManagerOptions() {
        const options = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>',
            ...MANAGER_NAMES.map(name => `<option value="${name}">${name}</option>`),
            '<option value="other">(–î—Ä—É–≥–æ–µ)</option>'
        ];
        managerSelect.innerHTML = options.join('');
    }

    function syncManagerValue() {
        if (managerSelect.value === 'other') {
            managerCustomInput.style.display = 'block';
            managerHiddenInput.value = managerCustomInput.value;
            managerCustomInput.focus();
        } else {
            managerCustomInput.style.display = 'none';
            managerCustomInput.value = '';
            managerHiddenInput.value = managerSelect.value;
        }
    }

    function setManagerName(name) {
        if (!name) {
            managerSelect.value = '';
            syncManagerValue();
            return;
        }
        if (MANAGER_NAMES.includes(name)) {
            managerSelect.value = name;
            syncManagerValue();
        } else {
            managerSelect.value = 'other';
            managerCustomInput.style.display = 'block';
            managerCustomInput.value = name;
            managerHiddenInput.value = name;
        }
    }

    managerSelect.addEventListener('change', () => {
        syncManagerValue();
    });

    managerCustomInput.addEventListener('input', () => {
        if (managerSelect.value === 'other') {
            managerHiddenInput.value = managerCustomInput.value;
        }
    });

    renderManagerOptions();

    // --- –ü–û–ò–°–ö –ü–ê–ö–ï–¢–û–í ---
    async function handleSearch() {
        let date = document.getElementById('date_input').value.trim().replace(/[\/\s,]/g, '.');
        document.getElementById('date_input').value = date;

        if (date.length < 5) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–∞–ø—Ä. 13.12)");

        const sel = document.getElementById('pkg_name');
        sel.innerHTML = '<option class="loading">‚è≥ –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤...</option>';

        try {
            const r = await fetch(`${API_URL}/api/packages?date=${date}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await r.json();

            if (res.found) {
                sel.disabled = false;
                sel.innerHTML = res.data.map(i => `<option value="${i.n}" data-sheet="${i.s}" data-table="${i.t}">${i.n}</option>`).join('');
                document.getElementById('sheet_name_hidden').value = res.data[0].s;
                document.getElementById('table_id_hidden').value = res.data[0].t;
            } else {
                sel.innerHTML = '<option>‚ùå –ù–µ—Ç —Ä–µ–π—Å–æ–≤</option>';
                sel.disabled = true;
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
    }

    document.getElementById('date_input').addEventListener('input', function() {
        if (currentMode === 'edit') return;
        if (this.value.length === 5) handleSearch();
    });

    document.getElementById('pkg_name').onchange = (e) => {
        if (currentMode === 'edit') return;
        const opt = e.target.options[e.target.selectedIndex];
        document.getElementById('sheet_name_hidden').value = opt.dataset.sheet;
        document.getElementById('table_id_hidden').value = opt.dataset.table;
    };

    // --- –ü–ê–†–°–ò–ù–ì –¢–£–†–ò–°–¢–û–í –ò–ó URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const pRaw = urlParams.get('pilgrims');
    const fillModeParam = (urlParams.get('fill_mode') || '').toLowerCase();
    const countParam = parseInt((urlParams.get('count') || '').trim() || '0', 10);
    const modeParam = urlParams.get('mode');
    const editBookingId = urlParams.get('booking_id');
    const oldBookingId = urlParams.get('old_booking_id');

    console.log("üì• URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:");
    console.log("   pilgrims:", pRaw ? "–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ" : "–Ω–µ—Ç");
    console.log("   mode:", modeParam);
    console.log("   booking_id:", editBookingId);
    console.log("   old_booking_id:", oldBookingId);

    currentMode = modeParam || localStorage.getItem('mode') || 'create';
    currentBookingId = editBookingId || localStorage.getItem('edit_booking_id') || null;
    let currentOldBookingId = oldBookingId || localStorage.getItem('old_booking_id') || null;

    function showStep0() {
        document.getElementById('step_0').style.display = 'block';
        document.getElementById('step_1').style.display = 'none';
        document.getElementById('step_2').style.display = 'none';
        window.scrollTo(0, 0);
    }

    function showStep1() {
        document.getElementById('step_0').style.display = 'none';
        document.getElementById('step_1').style.display = 'block';
        document.getElementById('step_2').style.display = 'none';
        window.scrollTo(0, 0);
    }

	    function fileSignature(file) {
	        return `${file.name}::${file.size}::${file.lastModified || 0}`;
	    }

	    function escapeHtml(str) {
	        return String(str)
	            .replaceAll('&', '&amp;')
	            .replaceAll('<', '&lt;')
	            .replaceAll('>', '&gt;')
	            .replaceAll('"', '&quot;')
	            .replaceAll("'", '&#39;');
	    }

	    function addFiles(files) {
	        const incoming = Array.from(files || []);
	        if (!incoming.length) return;

	        const existing = new Set(passportFiles.map(fileSignature));
        for (const file of incoming) {
            const sig = fileSignature(file);
            if (existing.has(sig)) continue;
            passportFiles.push(file);
            existing.add(sig);
        }

        renderFilesList();
        document.getElementById('start_processing_btn').disabled = passportFiles.length === 0 || processingInProgress;
    }

	    function renderFilesList(statusMap = {}) {
	        const list = document.getElementById('files_list');
	        if (!list) return;
	        if (!passportFiles.length) {
	            list.innerHTML = '<div style="margin-top:8px;">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
	            return;
	        }
	        list.innerHTML = passportFiles.map((f, i) => {
	            const status = statusMap[i] || '–ì–æ—Ç–æ–≤';
	            const disabled = processingInProgress ? 'disabled' : '';
	            return `
	                <div class="file-item">
	                    <div>${i + 1}. ${escapeHtml(f.name)}</div>
	                    <div class="file-actions">
	                        <button type="button" class="file-remove" data-idx="${i}" ${disabled}>–û—Ç–º–µ–Ω–∏—Ç—å</button>
	                        <div class="file-status">${escapeHtml(status)}</div>
	                    </div>
	                </div>
	            `;
	        }).join('');
	    }

    async function uploadPassportFile(file) {
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`${API_URL}/api/passports/upload`, {
            method: "POST",
            body: formData,
            headers: {"ngrok-skip-browser-warning":"1"}
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.ok) throw new Error(json.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ${res.status}`);
        return json;
    }

    function buildPilgrimFromParsed(parsed, filename) {
        const data = parsed?.data || parsed?.parsed_data || {};
        const firstName = data.first_name || "-";
        const lastName = data.last_name || "-";
        const gender = data.gender || "-";
        const dob = data.date_of_birth || "-";
        const passportNum = data.passport_num || "-";
        const expiry = data.passport_expiry || "-";
        const iin = data.iin || "-";
        const passportPath = parsed?.path || null;
        const displayName = `${lastName !== '-' ? lastName : ''} ${firstName !== '-' ? firstName : ''}`.trim() || '-';

        return {
            name: displayName,
            last_name: lastName,
            first_name: firstName,
            phone: "-",
            passport_num: passportNum,
            date_of_birth: dob,
            gender: gender,
            passport_expiry: expiry,
            iin: iin,
            passport_image_path: passportPath,
            _source_file: filename || "",
            is_infant: false,
            is_child: false
        };
    }

    async function processAllPassportsAndCreatePilgrims() {
        if (processingInProgress) return;
        if (!creationCount || creationCount < 1) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤");
        if (!passportFiles.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –ø–∞—Å–ø–æ—Ä—Ç–æ–≤");

        processingInProgress = true;
        const statusMap = {};
        const btn = document.getElementById('start_processing_btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="icon">‚è≥</span> –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';

        const results = [];
        try {
            for (let i = 0; i < passportFiles.length; i++) {
                statusMap[i] = '‚è≥';
                renderFilesList(statusMap);
                try {
                    const parsed = await uploadPassportFile(passportFiles[i]);
                    results.push({ ok: true, file: passportFiles[i], parsed });
                    statusMap[i] = parsed.parsed ? '‚úÖ' : '‚ö†Ô∏è';
                } catch (e) {
                    results.push({ ok: false, file: passportFiles[i], error: String(e?.message || e) });
                    statusMap[i] = '‚ùå';
                }
                renderFilesList(statusMap);
            }

            const okResults = results.filter(r => r.ok).map(r => buildPilgrimFromParsed(r.parsed, r.file?.name));

            if (passportsCompleteness === 'all' && okResults.length < creationCount) {
                alert(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–∞—Å–ø–æ—Ä—Ç–æ–≤: ${okResults.length}/${creationCount}. –ï—Å–ª–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞ —á–∞—Å—Ç–∏—á–Ω—ã–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ "–ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞".`);
                return;
            }

            const pilgrims = okResults.slice(0, creationCount);
            while (pilgrims.length < creationCount) {
                pilgrims.push({
                    name: '-',
                    last_name: '-',
                    first_name: '-',
                    phone: '-',
                    passport_num: '-',
                    date_of_birth: '-',
                    gender: '-',
                    passport_expiry: '-',
                    iin: '-',
                    passport_image_path: null,
                    is_infant: false,
                    is_child: false
                });
            }

            pilgrimsData = pilgrims;
            console.log("üßæ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –ø–∞–ª–æ–º–Ω–∏–∫–∏ –∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–æ–≤:", pilgrimsData);
            showStep1();
            renderPilgrims();

        } finally {
            processingInProgress = false;
            btn.disabled = false;
            btn.innerHTML = '–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
        }
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ URL (–±–æ—Ç)
    if (pRaw) {
        try {
            const pilgrims = JSON.parse(decodeURIComponent(pRaw));
            console.log("‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", pilgrims);

            pilgrimsData = pilgrims.map(p => ({
                name: p.name || `${p.last_name || '-'} ${p.first_name || '-'}`,
                last_name: p.last_name || "-",
                first_name: p.first_name || "-",
                phone: p.phone || "-",
                passport_num: p.passport_num || "-",
                date_of_birth: p.date_of_birth || "-",
                gender: p.gender || "M",
                passport_expiry: p.passport_expiry || "-",
                iin: p.iin || "-",
                passport_image_path: p.passport_image_path || null,
                is_infant: p.is_infant || false,
                is_child: p.is_child || false
            }));

            console.log("üìã –§–∏–Ω–∞–ª—å–Ω—ã–π pilgrimsData:", pilgrimsData);
            showStep1();
            renderPilgrims();
        } catch(e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:", e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Å–ø–æ—Ä—Ç–æ–≤");
        }
    } else {
        // –§–æ–ª–±–µ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏: —á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
        const isReschedule = localStorage.getItem('is_reschedule') === 'true';
        const rescheduleDataRaw = localStorage.getItem('reschedule_data');
        const isEdit = localStorage.getItem('is_edit') === 'true';
        const editDataRaw = localStorage.getItem('edit_data');

        if (isReschedule && rescheduleDataRaw) {
            try {
                const p = JSON.parse(rescheduleDataRaw);
                pilgrimsData = [{
                    name: `${p.last_name || '-'} ${p.first_name || '-'}`,
                    last_name: p.last_name || "-",
                    first_name: p.first_name || "-",
                    phone: p.phone || "-",
                    passport_num: p.passport_num || "-",
                    date_of_birth: p.date_of_birth || "-",
                    gender: p.gender || "M",
                    passport_expiry: p.passport_expiry || "-",
                    iin: p.iin || "-",
                    passport_image_path: p.passport_image_path || null
                }];
                console.log("‚ôªÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–∑ localStorage:", pilgrimsData);
                showStep1();
                renderPilgrims();
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:", e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–∞");
            } finally {
                localStorage.removeItem('is_reschedule');
                localStorage.removeItem('reschedule_data');
                localStorage.removeItem('reschedule_booking_id');
            }
        } else if (isEdit && editDataRaw) {
            try {
                const p = JSON.parse(editDataRaw);
                currentMode = 'edit';
                currentBookingId = localStorage.getItem('edit_booking_id') || null;
                pilgrimsData = [{
                    name: `${p.last_name || '-'} ${p.first_name || '-'}`,
                    last_name: p.last_name || "-",
                    first_name: p.first_name || "-",
                    phone: p.phone || "-",
                    passport_num: p.passport_num || "-",
                    date_of_birth: p.date_of_birth || "-",
                    gender: p.gender || "M",
                    passport_expiry: p.passport_expiry || "-",
                    iin: p.iin || "-",
                    passport_image_path: p.passport_image_path || null
                }];
                console.log("‚úèÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ localStorage:", pilgrimsData);
                showStep1();
                renderPilgrims();
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
            } finally {
                // –ù–µ —á–∏—Å—Ç–∏–º edit-—Ñ–ª–∞–≥–∏ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
            }
        } else {
            // –ù–∏–∫–∞–∫–∏—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ WebApp
            showStep0();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –Ω–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è (–µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞–Ω step_0)
    const createBtn = document.getElementById('create_booking_btn');
    const createFlow = document.getElementById('create_flow');
    const countInput = document.getElementById('pilgrims_count_input');
    const fillTgBtn = document.getElementById('fill_tg_btn');
    const fillFormBtn = document.getElementById('fill_form_btn');
    const formPassportBlock = document.getElementById('form_passport_block');
    const allBtn = document.getElementById('passports_all_btn');
    const partialBtn = document.getElementById('passports_partial_btn');
    const dropzone = document.getElementById('passport_dropzone');
    const chooseFilesBtn = document.getElementById('choose_files_btn');
    const filesInput = document.getElementById('passports_files_input');
    const startProcessingBtn = document.getElementById('start_processing_btn');

    if (createBtn) {
        createBtn.addEventListener('click', () => {
            createFlow.style.display = 'block';
            createBtn.style.display = 'none';
        });
    }

    function readCount() {
        const v = parseInt((countInput?.value || '').trim(), 10);
        if (!Number.isFinite(v) || v < 1) return 0;
        return Math.min(30, v);
    }

    if (countInput) {
        countInput.addEventListener('input', () => {
            creationCount = readCount();
        });
    }

    function setCompleteness(value) {
        passportsCompleteness = value;
        if (allBtn && partialBtn) {
            allBtn.style.borderColor = value === 'all' ? 'var(--accent-brown)' : 'var(--border-color)';
            partialBtn.style.borderColor = value === 'partial' ? 'var(--accent-brown)' : 'var(--border-color)';
        }
    }
    setCompleteness('partial');

    if (allBtn) allBtn.addEventListener('click', () => setCompleteness('all'));
    if (partialBtn) partialBtn.addEventListener('click', () => setCompleteness('partial'));

    if (fillTgBtn) {
        fillTgBtn.addEventListener('click', () => {
            creationCount = readCount();
            if (!creationCount) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤");
            try {
                tg.sendData(JSON.stringify({ action: "create_booking", fill_mode: "tg", count: creationCount }));
            } catch (e) {
                // no-op
            }
            tg.close();
        });
    }

    if (fillFormBtn) {
        fillFormBtn.addEventListener('click', () => {
            creationCount = readCount();
            if (!creationCount) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤");
            creationMode = 'form';
            fillTgBtn.style.display = 'none';
            fillFormBtn.style.display = 'none';
            formPassportBlock.style.display = 'block';
            renderFilesList();
        });
    }

	    if (chooseFilesBtn && filesInput) {
	        chooseFilesBtn.addEventListener('click', () => filesInput.click());
	        filesInput.addEventListener('change', (e) => {
	            addFiles(e.target.files);
	            e.target.value = '';
	        });
	    }

	    const filesList = document.getElementById('files_list');
	    if (filesList) {
	        filesList.addEventListener('click', (e) => {
	            const btn = e.target?.closest?.('.file-remove');
	            if (!btn) return;
	            if (processingInProgress) return;
	            const idx = parseInt(btn.dataset.idx || '', 10);
	            if (!Number.isFinite(idx) || idx < 0 || idx >= passportFiles.length) return;
	            passportFiles.splice(idx, 1);
	            renderFilesList();
	            document.getElementById('start_processing_btn').disabled = passportFiles.length === 0 || processingInProgress;
	        });
	    }

	    if (dropzone) {
	        dropzone.addEventListener('dragover', (e) => {
	            e.preventDefault();
	            dropzone.classList.add('dragover');
	        });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            addFiles(e.dataTransfer.files);
        });
    }

    if (startProcessingBtn) {
        startProcessingBtn.addEventListener('click', processAllPassportsAndCreatePilgrims);
    }

    // –ï—Å–ª–∏ –±–æ—Ç —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –≤—ã–±—Ä–∞–ª–∏ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤ —Ñ–æ—Ä–º–µ" ‚Äî —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫
    if (!pRaw && fillModeParam === 'form' && Number.isFinite(countParam) && countParam > 0) {
        showStep0();
        createFlow.style.display = 'block';
        createBtn.style.display = 'none';
        countInput.value = String(Math.min(30, countParam));
        creationCount = readCount();
        creationMode = 'form';
        fillTgBtn.style.display = 'none';
        fillFormBtn.style.display = 'none';
        formPassportBlock.style.display = 'block';
        renderFilesList();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    applyEditLock();

    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ –∏–∑ API
    if (currentMode === 'edit' && currentBookingId) {
        console.log("üìã –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –∑–∞–≥—Ä—É–∂–∞—é –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ #" + currentBookingId);
        loadBookingData(currentBookingId);
    }

    function renderPilgrims() {
        const container = document.getElementById('pilgrims-container');
        container.innerHTML = pilgrimsData.map((p, idx) => `
            <div class="tourist-card">
                <div class="tourist-header">
                    <span class="tourist-name" data-name-idx="${idx}">üë§ ${p.last_name} ${p.first_name}</span>
                    <button onclick="togglePassportData(${idx})" class="passport-btn">
                        üìã –ü–∞—Å–ø–æ—Ä—Ç
                    </button>
                </div>
                <div class="name-row">
                    <input type="text" class="name-input last-name-input" data-idx="${idx}" placeholder="–§–∞–º–∏–ª–∏—è" value="${p.last_name !== '-' ? p.last_name : ''}">
                    <input type="text" class="name-input first-name-input" data-idx="${idx}" placeholder="–ò–º—è" value="${p.first_name !== '-' ? p.first_name : ''}">
                </div>
                <div class="name-hint">–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è/—Ñ–∞–º–∏–ª–∏—é, –µ—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
                <input type="tel" class="phone-input" data-idx="${idx}" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" value="${p.phone !== '-' ? p.phone : ''}">
                <select class="gender-select" data-idx="${idx}">
                    <option value="" ${(!p.gender || p.gender === '-') ? 'selected' : ''}>–ü–æ–ª (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ</option>
                    <option value="M" ${p.gender === 'M' ? 'selected' : ''}>–ú—É–∂—Å–∫–æ–π</option>
                    <option value="F" ${p.gender === 'F' ? 'selected' : ''}>–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>

                <div class="passenger-type-checkboxes">
                    <label>
                        <input type="checkbox" class="inf-checkbox" data-idx="${idx}" ${p.is_infant ? 'checked' : ''}>
                        üë∂ INF (–ú–ª–∞–¥–µ–Ω–µ—Ü)
                    </label>
                    <label>
                        <input type="checkbox" class="chd-checkbox" data-idx="${idx}" ${p.is_child ? 'checked' : ''}>
                        üßí CHD (–†–µ–±–µ–Ω–æ–∫)
                    </label>
                </div>

                <div id="passport_${idx}" class="passport-data">
                    <div class="passport-field"><strong>–§–∞–º–∏–ª–∏—è:</strong> <span class="passport-last-name">${p.last_name}</span></div>
                    <div class="passport-field"><strong>–ò–º—è:</strong> <span class="passport-first-name">${p.first_name}</span></div>
                    <div class="passport-field"><strong>–ü–æ–ª:</strong> <span>${p.gender === 'M' ? 'üë® –ú—É–∂—Å–∫–æ–π' : 'üë© –ñ–µ–Ω—Å–∫–∏–π'}</span></div>
                    <div class="passport-field"><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span>${p.date_of_birth}</span></div>
                    <div class="passport-field"><strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong> <span>${p.passport_num}</span></div>
                    <div class="passport-field"><strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> <span>${p.passport_expiry}</span></div>
                    <div class="passport-field"><strong>–ò–ò–ù:</strong> <span>${p.iin}</span></div>
                </div>
            </div>
        `).join('');

        const nameInputs = document.querySelectorAll('.name-input');
        const phoneInputs = document.querySelectorAll('.phone-input');
        const genderSelects = document.querySelectorAll('.gender-select');

        function updateNameDisplay(idx) {
            const data = pilgrimsData[idx];
            const header = document.querySelector(`[data-name-idx="${idx}"]`);
            const displayName = `${data.last_name !== '-' ? data.last_name : ''} ${data.first_name !== '-' ? data.first_name : ''}`.trim();
            if (header) {
                header.textContent = `üë§ ${displayName || '-'}`;
            }
            const lastSpan = document.querySelector(`#passport_${idx} .passport-last-name`);
            const firstSpan = document.querySelector(`#passport_${idx} .passport-first-name`);
            if (lastSpan) lastSpan.textContent = data.last_name;
            if (firstSpan) firstSpan.textContent = data.first_name;
            data.name = displayName || '-';

            const genderSelect = document.querySelector(`.gender-select[data-idx="${idx}"]`);
            if (genderSelect && (data.gender === 'M' || data.gender === 'F')) {
                genderSelect.value = data.gender;
            }
        }

        nameInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const idx = e.target.dataset.idx;
                if (typeof pilgrimsData[idx] === 'undefined') return;
                if (e.target.classList.contains('last-name-input')) {
                    pilgrimsData[idx].last_name = e.target.value.trim() || '-';
                } else {
                    pilgrimsData[idx].first_name = e.target.value.trim() || '-';
                }
                updateNameDisplay(idx);
            });
        });

        phoneInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const idx = e.target.dataset.idx;
                pilgrimsData[idx].phone = e.target.value;
            });
        });

        genderSelects.forEach(select => {
            select.addEventListener('change', (e) => {
                const idx = e.target.dataset.idx;
                if (typeof pilgrimsData[idx] === 'undefined') return;
                pilgrimsData[idx].gender = e.target.value;
                updateNameDisplay(idx);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ INF/CHD (–≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ)
        const infCheckboxes = document.querySelectorAll('.inf-checkbox');
        const chdCheckboxes = document.querySelectorAll('.chd-checkbox');

        infCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const idx = e.target.dataset.idx;
                if (typeof pilgrimsData[idx] === 'undefined') return;

                pilgrimsData[idx].is_infant = e.target.checked;

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω INF, —Å–Ω–∏–º–∞–µ–º CHD
                if (e.target.checked) {
                    pilgrimsData[idx].is_child = false;
                    const chdCheckbox = document.querySelector(`.chd-checkbox[data-idx="${idx}"]`);
                    if (chdCheckbox) chdCheckbox.checked = false;
                }

                console.log(`–ü–∞–ª–æ–º–Ω–∏–∫ ${idx}: INF=${pilgrimsData[idx].is_infant}, CHD=${pilgrimsData[idx].is_child}`);
            });
        });

        chdCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const idx = e.target.dataset.idx;
                if (typeof pilgrimsData[idx] === 'undefined') return;

                pilgrimsData[idx].is_child = e.target.checked;

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω CHD, —Å–Ω–∏–º–∞–µ–º INF
                if (e.target.checked) {
                    pilgrimsData[idx].is_infant = false;
                    const infCheckbox = document.querySelector(`.inf-checkbox[data-idx="${idx}"]`);
                    if (infCheckbox) infCheckbox.checked = false;
                }

                console.log(`–ü–∞–ª–æ–º–Ω–∏–∫ ${idx}: INF=${pilgrimsData[idx].is_infant}, CHD=${pilgrimsData[idx].is_child}`);
            });
        });
    }
    function togglePassportData(idx) {
        const el = document.getElementById(`passport_${idx}`);
        el.classList.toggle('visible');
    }

    function applyEditLock() {
        if (currentMode !== 'edit') return;
        const dateInput = document.getElementById('date_input');
        const pkgSelect = document.getElementById('pkg_name');
        if (dateInput) dateInput.disabled = true;
        if (pkgSelect) pkgSelect.disabled = true;
        const notice = document.getElementById('edit_notice');
        if (notice) notice.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    async function loadBookingData(bookingId) {
        try {
            console.log("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏ #" + bookingId);
            const res = await fetch(`${API_URL}/api/bookings/${bookingId}`, {
                headers: {"ngrok-skip-browser-warning": "1"}
            });
            const json = await res.json();

            if (!res.ok || !json.ok) {
                throw new Error(json.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏");
            }

            const booking = json.booking;
            console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ –ø–æ–ª—É—á–µ–Ω—ã:", booking);

            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            if (booking.package_name) {
                const pkgSelect = document.getElementById('pkg_name');
                pkgSelect.innerHTML = `<option value="${booking.package_name}">${booking.package_name}</option>`;
                pkgSelect.value = booking.package_name;
                pkgSelect.disabled = true;
            }

            if (booking.sheet_name) {
                document.getElementById('sheet_name_hidden').value = booking.sheet_name;
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "JUNE 15.06")
                const dateMatch = booking.sheet_name.match(/(\d{1,2})\.(\d{1,2})/);
                if (dateMatch) {
                    document.getElementById('date_input').value = `${dateMatch[1]}.${dateMatch[2]}`;
                }
            }

            // –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (radio buttons)
            if (booking.departure_city) {
                const cityRadio = document.querySelector(`input[name="departure_city"][value="${booking.departure_city}"]`);
                if (cityRadio) cityRadio.checked = true;
            }

            // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
            if (booking.price) {
                document.getElementById('price').value = booking.price;
            }

            if (booking.amount_paid) {
                document.getElementById('amount_paid').value = booking.amount_paid;
            }

            if (booking.room_type) {
                document.getElementById('room_type').value = booking.room_type;
            }

            if (booking.meal_type) {
                document.getElementById('meal_type').value = booking.meal_type;
            }

            if (booking.visa_status) {
                document.getElementById('visa_status').value = booking.visa_status;
            }

            if (booking.avia) {
                document.getElementById('avia').value = booking.avia;
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (booking.region) {
                document.getElementById('region').value = booking.region;
            }

            if (booking.contract_number) {
                document.getElementById('contract_number').value = booking.contract_number;
            }

            if (booking.exchange_rate) {
                document.getElementById('exchange_rate').value = booking.exchange_rate;
            }

            if (booking.discount) {
                document.getElementById('discount').value = booking.discount;
            }

            if (booking.source) {
                document.getElementById('source').value = booking.source;
            }

            if (booking.train) {
                document.getElementById('train').value = booking.train;
            }

            // –ú–µ–Ω–µ–¥–∂–µ—Ä –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (booking.manager_name_text) {
                setManagerName(booking.manager_name_text);
            }

            if (booking.comment && booking.comment !== '-') {
                document.getElementById('comment').value = booking.comment;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å table_id, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
            if (booking.table_id) {
                const tableIdInput = document.getElementById('table_id_hidden');
                if (tableIdInput) {
                    tableIdInput.value = booking.table_id;
                }
            }

            console.log("‚úÖ –í—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω—ã");
            applyEditLock();
            return booking;
        } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏:", e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏: " + e.message);
            return null;
        }
    }

    // –ü–æ–ª–µ "–ú–µ–Ω–µ–¥–∂–µ—Ä" —Ç–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
    // if (tg.initDataUnsafe?.user) {
    //     document.getElementById('manager_name_text').value = tg.initDataUnsafe.user.first_name;
    // }

    function goToStep2() {
        const pkg = document.getElementById('pkg_name').value;
        const price = document.getElementById('price').value;
        if (!pkg || pkg === "" || !price) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ü–∞–∫–µ—Ç –∏ –¶–µ–Ω—É!");

        // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (currentMode === 'edit') {
            finalSubmit();
            return;
        }

        document.getElementById('step_1').style.display = 'none';
        document.getElementById('step_2').style.display = 'block';
        window.scrollTo(0, 0);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ –±–æ–ª—å—à–µ 1
        if (pilgrimsData.length > 1) {
            document.getElementById('group_logic').style.display = 'block';
        }

        fetchAvailableRooms();
    }

    function backToStep1() {
        document.getElementById('step_2').style.display = 'none';
        document.getElementById('step_1').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function updateUI() {
        const m = document.querySelector('input[name="place_method"]:checked').value;
        document.getElementById('room_list_div').style.display = m === 'pick' ? 'block' : 'none';
        document.getElementById('manual_div').style.display = m === 'manual' ? 'block' : 'none';
    }

    async function fetchAvailableRooms() {
        const sel = document.getElementById('room_select');
        sel.innerHTML = '<option class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç...</option>';

        const params = new URLSearchParams({
            table_id: document.getElementById('table_id_hidden').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            package_name: document.getElementById('pkg_name').value,
            count: pilgrimsData.length,
            room_type: document.getElementById('room_type').value,
            gender: pilgrimsData[0]?.gender || 'M'
        });

        try {
            const r = await fetch(`${API_URL}/api/rooms?${params}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await r.json();
            if (res.found && res.rooms.length > 0) {
                sel.innerHTML = res.rooms.map(rm => {
                    const icon = rm.gender === 'F' ? 'üö∫' : 'üöπ';
                    const label = rm.label || `${rm.type} ¬∑ ${rm.last_guest || '–°–≤–æ–±–æ–¥–Ω–æ'} (–°–≤–æ–±–æ–¥–Ω–æ: ${rm.free})`;
                    return `<option value="${rm.row}">${icon} ${label} [–°—Ç—Ä–æ–∫–∞: ${rm.row}]</option>`;
                }).join('');
            } else {
                sel.innerHTML = '<option value="">–ù–µ—Ç –º–µ—Å—Ç –¥–ª—è –ø–æ–¥—Å–µ–ª–µ–Ω–∏—è</option>';
            }
        } catch(e) { sel.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
    }

    async function finalSubmit() {
        // –í edit-—Ä–µ–∂–∏–º–µ –Ω–µ –∏–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
        const method = currentMode === 'edit'
            ? 'auto'
            : document.querySelector('input[name="place_method"]:checked').value;
        let row = null;
        if (method === 'pick') row = document.getElementById('room_select').value;
        if (method === 'manual') row = document.getElementById('manual_row_input').value;

        for (let i = 0; i < pilgrimsData.length; i++) {
            const p = pilgrimsData[i];
            const hasName = (p.first_name && p.first_name !== '-') || (p.last_name && p.last_name !== '-');
            const hasGender = p.gender === 'M' || p.gender === 'F';
            if (hasName && !hasGender) {
                alert(`–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª –¥–ª—è –ø–∞–ª–æ–º–Ω–∏–∫–∞ #${i + 1}`);
                return;
            }
        }

        const pilgrims = pilgrimsData.map(p => ({
            first_name: p.first_name,
            last_name: p.last_name,
            phone: p.phone,
            passport_num: p.passport_num,
            date_of_birth: p.date_of_birth,
            gender: p.gender,
            passport_expiry: p.passport_expiry,
            iin: p.iin,
            passport_image_path: p.passport_image_path || null,
            is_infant: p.is_infant || false,
            is_child: p.is_child || false
        }));

        console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", pilgrims);

        const data = {
            pilgrims: pilgrims,
            package_name: document.getElementById('pkg_name').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            table_id: document.getElementById('table_id_hidden').value,
            departure_city: document.querySelector('input[name="departure_city"]:checked').value,
            room_type: document.getElementById('room_type').value,
            meal_type: document.getElementById('meal_type').value,
            visa_status: document.getElementById('visa_status').value,
            avia: document.getElementById('avia').value,
            price: document.getElementById('price').value,
            amount_paid: document.getElementById('amount_paid').value,
            contract_number: document.getElementById('contract_number').value,
            exchange_rate: document.getElementById('exchange_rate').value,
            discount: document.getElementById('discount').value,
            source: document.getElementById('source').value,
            region: document.getElementById('region').value,
            train: document.getElementById('train').value,
            manager_name_text: managerHiddenInput.value,
            comment: document.getElementById('comment').value,
            placement_type: document.querySelector('input[name="placement_type"]:checked')?.value || 'separate',
            specific_row: row ? parseInt(row) : null,
            manager_id: tg.initDataUnsafe?.user?.id || 0
        };

        console.log("üì§ –†–µ–∂–∏–º –æ—Ç–ø—Ä–∞–≤–∫–∏:", currentMode);
        console.log("   booking_id:", currentBookingId);
        console.log("   old_booking_id:", currentOldBookingId);

        try {
            const btn = document.getElementById('finish_btn');
            btn.disabled = true;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º endpoint –∏ –º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let endpoint, method, btnText;

            if (currentMode === 'edit' && currentBookingId) {
                // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±—Ä–æ–Ω—å
                endpoint = `${API_URL}/api/bookings/${currentBookingId}`;
                method = "PATCH";
                btnText = '<span class="icon">‚è≥</span> –°–æ—Ö—Ä–∞–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è...';
                console.log("‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –±—Ä–æ–Ω–∏ #" + currentBookingId);
            } else {
                // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±—Ä–æ–Ω—å
                endpoint = `${API_URL}/api/bookings/submit`;
                method = "POST";
                btnText = '<span class="icon">‚è≥</span> –ó–∞–ø–∏—Å—ã–≤–∞—é...';

                if (currentMode === 'reschedule' && currentOldBookingId) {
                    console.log("‚ôªÔ∏è –ü–ï–†–ï–ù–û–° –±—Ä–æ–Ω–∏ (—Å—Ç–∞—Ä–∞—è #" + currentOldBookingId + ")");
                } else {
                    console.log("‚ûï –°–û–ó–î–ê–ù–ò–ï –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏");
                }
            }

            btn.innerHTML = btnText;

            const res = await fetch(endpoint, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "1"
                },
                body: JSON.stringify(data)
            });

            const json = await res.json().catch(() => ({}));

            if (!res.ok || !json.ok) {
                const msg = json.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`;
                alert("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: " + msg);
                btn.disabled = false;
                btn.innerHTML = '<span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let successMessage;
            if (currentMode === 'edit') {
                successMessage = "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!";
            } else if (currentMode === 'reschedule') {
                successMessage = "‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!";
            } else {
                successMessage = "‚úÖ –ë—Ä–æ–Ω—å —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–∞!";
            }
            alert(successMessage);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Telegram –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            tg.sendData(JSON.stringify({
                action: "booking_completed",
                mode: currentMode,
                saved_rows: json.saved_rows || []
            }));

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            tg.close();
        } catch (e) {
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e);
            const btn = document.getElementById('finish_btn');
            btn.disabled = false;
            btn.innerHTML = '<span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨';
        }
    }
</script>
</body>
</html>
